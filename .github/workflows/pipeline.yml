name: coffee-ci-cd

on:
    push:
        branches: ["**"]
    pull_request:
        branches: ["develop"]

permissions:
    contents: read
    packages: write

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: coffee-app
    PYTHON_VERSION: "3.11"

jobs:
    ci:
        name: CI (ruff + pytest)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install deps
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Lint (ruff)
              run: ruff check .

            - name: Unit tests (pytest)
              run: pytest -q

    build_push:
        name: Build & Push Image (GHCR)
        runs-on: ubuntu-latest
        needs: [ci]
        if: >
            github.event_name == 'push' &&
            (github.ref_name == 'develop' || startsWith(github.ref_name, 'release/') || github.ref_name == 'main')
        outputs:
            image: ${{ steps.meta.outputs.image }}
            tag: ${{ steps.meta.outputs.tag }}
        steps:
            - uses: actions/checkout@v4

            - name: Compute image tag
              id: meta
              shell: bash
              run: |
                  SHORTSHA="${GITHUB_SHA::7}"
                  BRANCH="${GITHUB_REF_NAME}"

                  if [ "$BRANCH" = "develop" ]; then
                    TAG="dev-$SHORTSHA"
                  elif [[ "$BRANCH" == release/* ]]; then
                    VER="${BRANCH#release/}"
                    TAG="rc-$VER-${GITHUB_RUN_NUMBER}"
                  elif [ "$BRANCH" = "main" ]; then
                    TAG="sha-$SHORTSHA"
                  else
                    TAG="noop"
                  fi

                  OWNER_LC=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
                  IMAGE="${{ env.REGISTRY }}/${OWNER_LC}/${{ env.IMAGE_NAME }}:${TAG}"

                  echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
                  echo "tag=$TAG" >> "$GITHUB_OUTPUT"

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push
              shell: bash
              run: |
                  docker build -t "${{ steps.meta.outputs.image }}" .
                  docker push "${{ steps.meta.outputs.image }}"

    deploy:
        name: Deploy to Kubernetes
        runs-on: ubuntu-latest
        needs: [build_push]
        if: github.event_name == 'push' && (github.ref_name == 'develop' || github.ref_name == 'main')
        environment: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
